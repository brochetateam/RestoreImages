<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Restauración de fotos antiguas AI online</title>
  <meta name="description" content="Restaura fotos antiguas en segundos con IA. Sube tu imagen y obtén una versión mejorada al instante." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff;
      --text:#0f172a;
      --muted:#596377;
      --card:#f6f7fb;
      --border:#e5e7eb;
      --accent:#4f46e5;
      --accent-2:#06b6d4;
      --shadow:0 10px 30px rgba(2,6,23,.08);
    }
    body.dark{
      --bg:#0b1220;
      --text:#e6eaf3;
      --muted:#9aa4b2;
      --card:#0f172a;
      --border:#1f2937;
      --shadow:0 10px 30px rgba(0,0,0,.45);
    }
    *{
      box-sizing:border-box
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      line-height:1.55;
    }
    a{
      color:inherit;
      text-decoration:none
    }
    .container{
      max-width:1200px;
      margin:0 auto;
      padding:0 20px
    }
    header{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:saturate(140%) blur(6px);
      background:color-mix(in srgb, var(--bg) 92%, transparent);
      border-bottom:1px solid var(--border);
    }
    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      height:64px;
      gap:16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      font-size:18px
    }
    .brand .dot{
      width:12px;
      height:12px;
      border-radius:50%;
      background:linear-gradient(135deg,#7c3aed,#06b6d4)
    }
    .right{
      display:flex;
      align-items:center;
      gap:10px
    }
    .apikey{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--card)
    }
    .apikey input{
      border:none;
      background:transparent;
      outline:none;
      color:var(--text);
      width:220px
    }
    .mini-btn{
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size: 14px;
    }
    .btn{
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#fff;
      border:none;
      padding:12px 18px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size: 14px;
    }
    .btn[disabled]{
      opacity:.6;
      cursor:not-allowed
    }
    .ghost{
      background:transparent;
      border:1px dashed var(--border);
      color:var(--text)
    }
    .download-btn{
      margin-left:auto
    }
    .theme-toggle{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:38px;
      height:38px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--bg);
      cursor:pointer
    }
    body.dark .theme-toggle { background: var(--card); }
    .theme-toggle svg{
      width:18px;
      height:18px
    }
    /* hero */
    .hero{
      padding:56px 0 28px
    }
    .hero h1{
      font-size:44px;
      line-height:1.05;
      margin:0 0 8px;
      font-weight:800;
      letter-spacing:-0.02em;
      text-wrap:balance;
      text-align:center
    }
    .hero p{
      color:var(--muted);
      text-align:center;
      margin:0 0 26px
    }
    .grid{
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:28px;
      align-items:stretch
    }
    @media (max-width:980px){
      .grid{
        grid-template-columns:1fr
      }
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px;
      height:100%
    }
    /* Before/after compare */
    .compare{
      position:relative;
      overflow:hidden;
      border-radius:12px;
      height:460px;
      background:#000
    }
    .compare img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      user-select:none;
      pointer-events:none
    }
    .compare .after{
      clip-path: inset(0 0 0 50%)
    }
    .compare .labels{
      position:absolute;
      inset:10px 10px auto auto;
      display:flex;
      gap:10px;
      z-index:3
    }
    .label{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.55);
      color:#fff
    }
    .label.left{
      position:absolute;
      left:10px;
      top:10px
    }
    .label.right{
      position:absolute;
      right:10px;
      top:10px
    }
    .slider-wrap{
      position:absolute;
      inset:0;
      z-index:4
    }
    .drag-line{
      position:absolute;
      top:0;
      bottom:0;
      left:50%;
      width:2px;
      background:#fff;
      box-shadow:0 0 0 1px rgba(0,0,0,.25)
    }
    .handle{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      width:36px;
      height:36px;
      border-radius:50%;
      background:#fff;
      color:#111;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 4px 16px rgba(0,0,0,.35);
      border:2px solid #fff
    }
    .handle::before,.handle::after{
      content:"";
      display:block;
      width:9px;
      height:9px;
      border-top:2px solid #111;
      border-right:2px solid #111;
      transform:rotate(45deg)
    }
    .handle::after{
      transform:rotate(-135deg)
    }
    .range{
      position:absolute;
      inset:0;
      opacity:0
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
      align-items:center
    }
    /* Uploader */
    .drop{
      display:flex;
      flex-direction:column;
      gap:12px;
      justify-content:center;
      align-items:center;
      min-height:460px;
      border:2px dashed var(--border);
      border-radius:12px;
      background:color-mix(in srgb,var(--card) 85%, transparent);
      text-align:center;
      padding:16px;
      position: relative;
    }
    .drop.dragover{
      border-color:var(--accent-2);
      background:color-mix(in srgb,var(--card) 70%, transparent)
    }
    .drop .hint{
      color:var(--muted)
    }
    .helper{
      font-size:12px;
      color:var(--muted)
    }
    /* Sections alternas */
    .section{
      padding:56px 0
    }
    .alt{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:26px;
      align-items:center
    }
    .alt .img{
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--border);
      box-shadow:var(--shadow)
    }
    .alt .img img{
      width:100%;
      height:100%;
      object-fit:cover
    }
    .alt .text h2{
      margin:0 0 10px;
      font-size:28px
    }
    .alt .text p{
      margin:0 0 14px;
      color:var(--muted)
    }
    @media (max-width:980px){
      .alt{
        grid-template-columns:1fr
      }
    }
    /* Footer */
    footer{
      border-top:1px solid var(--border);
      padding:26px 0;
      color:var(--muted);
      font-size:14px
    }
    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:var(--card);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:10px;
      box-shadow:var(--shadow);
      display:none
    }
    .toast.show{
      display:block
    }
    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0
    }
    
    /* Estilos para la vista previa de imagen */
    .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      display: none;
      margin-bottom: 15px;
    }
    
    /* Progress bar */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      margin: 10px 0;
      display: none;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* Error message */
    .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    
    /* Mejoras para móvil */
    @media (max-width: 768px) {
      .hero h1 {
        font-size: 32px;
      }
      
      .hero p {
        font-size: 16px;
      }
      
      .compare {
        height: 300px;
      }
      
      .drop {
        min-height: 300px;
      }
      
      .apikey {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .apikey input {
        width: 150px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn, .mini-btn {
        width: 100%;
        text-align: center;
      }
      
      .download-btn {
        margin-left: 0;
      }
    }
    
    @media (max-width: 480px) {
      .nav {
        flex-direction: column;
        height: auto;
        padding: 10px 0;
      }
      
      .right {
        width: 100%;
        justify-content: center;
        margin-top: 10px;
      }
      
      .hero {
        padding: 30px 0 20px;
      }
      
      .card {
        padding: 12px;
      }
      
      .section {
        padding: 40px 0;
      }
    }
  </style>
</head>
<body>
  <a id="top" class="sr-only">top</a>
  <header>
    <div class="container nav">
      <div class="brand">
        <span class="dot"></span>
        <span>FotoRestaurador AI</span>
      </div>
      <div class="right">
        <div class="apikey" title="Tu clave se guarda en localStorage">
          <span style="font-size:12px;color:var(--muted)">API Key:</span>
          <input id="apiKeyInput" type="password" placeholder="GEMINI_API_KEY" />
          <button class="mini-btn" id="saveKeyBtn">Guardar</button>
        </div>
        <button class="theme-toggle" id="themeBtn" aria-label="Cambiar tema">
          <svg id="iconSun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"></path>
          </svg>
          <svg id="iconMoon" viewBox="0 0 24 24" fill="currentColor" style="display:none">
            <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main>
    <section class="hero container">
      <h1>Restauración de fotos antiguas AI online</h1>
      <p>Restaura fotos en línea y dale vida y color a tus recuerdos en segundos.</p>

      <div class="grid">
        <!-- Comparador Antes/Después -->
        <div class="card">
          <div class="compare" id="compare">
            <span class="label left">Antes</span>
            <span class="label right">Después</span>
            <img id="imgBefore" class="before" alt="Antes" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDQwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjZjNmNGY2Ii8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTUwIiBmb250LWZhbWlseT0iSW50ZXIsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM2YjczODAiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkltYWdlbiBkZSBlamVtcGxvPC90ZXh0Pgo8L3N2Zz4=" />
            <img id="imgAfter" class="after" alt="Después" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDQwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjZWZmNmZmIi8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTUwIiBmb250LWZhbWlseT0iSW50ZXIsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM4YjVjZjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkltYWdlbiByZXN0YXVyYWRhPC90ZXh0Pgo8L3N2Zz4=" />
            <div class="slider-wrap">
              <div class="drag-line" id="dragLine"></div>
              <div class="handle" id="handle"></div>
              <input class="range" id="range" type="range" min="0" max="100" value="50" aria-label="Comparador antes/después" />
            </div>
          </div>
          <div class="controls">
            <span class="helper">El comparador mostrará aquí tu resultado.</span>
            <button id="downloadBtn" class="btn download-btn" style="display:none">Descargar resultado</button>
          </div>
        </div>

        <!-- Uploader + Acciones -->
        <div class="card">
          <div id="drop" class="drop">
            <div id="drop-text">
              <div style="font-weight:700;font-size:18px;margin-bottom:6px">Arrastra la imagen aquí o haz clic para cargar</div>
              <div class="hint">JPG, PNG o WEBP. También puedes pegar una imagen.</div>
            </div>
            
            <img id="imagePreview" class="image-preview" alt="Vista previa" />
            
            <input id="fileInput" type="file" accept="image/*" style="display:none" />
            
            <div class="progress-bar" id="progressBar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="controls">
              <button id="chooseBtn" class="btn">Elegir imagen</button>
              <button id="runBtn" class="btn" style="display:none">Restaurar Foto Ahora</button>
              <button id="removeBtn" class="mini-btn ghost" style="display:none">Quitar imagen</button>
              <span id="status" class="helper"></span>
              <div id="errorMessage" class="error-message"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Secciones alternas -->
    <section class="section">
      <div class="container alt">
        <div class="img">
          <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDQwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjZjNmNGY2Ii8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTQwIiBmb250LWZhbWlseT0iSW50ZXIsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2YjczODAiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkZvdG8gYW50aWd1YTwvdGV4dD4KPHRleHQgeD0iMjAwIiB5PSIxNjAiIGZvbnQtZmFtaWx5PSJJbnRlciwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZiNzM4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+KGJvcnJvc2EpPC90ZXh0Pgo8L3N2Zz4=" alt="">
        </div>
        <div class="text">
          <h2>Reparar fotos antiguas borrosas al instante con el restaurador de fotos antiguas AI</h2>
          <p>Restaurar foto en Photoshop requiere mucho tiempo y habilidades técnicas. Con el restaurador de fotos antiguas AI, todo el proceso de restauración se completa en segundos. Puedes arreglar la borrosidad y mejorar calidad de fotos viejas con unos pocos clics en nuestra herramienta de restauración de fotos antiguas AI, sin necesidad de edición. Simplemente, carga tu foto y deja el resto en nuestras manos, obtendrás una foto de alta calidad en segundos.</p>
          <button class="btn" onclick="window.scrollTo({top:0,behavior:'smooth'})">Restaurar foto ahora</button>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="container alt" style="direction:rtl">
        <div class="img" style="direction:ltr">
          <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDQwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjZWZmNmZmIi8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTQwIiBmb250LWZhbWlseT0iSW50ZXIsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM4YjVjZjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkZvdG8gcmVzdGF1cmFkYTwvdGV4dD4KPHRleHQgeD0iMjAwIiB5PSIxNjAiIGZvbnQtZmFtaWx5PSJJbnRlciwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzhiNWNmNiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+KG1lam9yYWRhKTwvdGV4dD4KPC9zdmc+" alt="">
        </div>
        <div class="text" style="direction:ltr">
          <h2>Revivir tus recuerdos especiales con la restauración de fotos antiguas AI</h2>
          <p>Cada foto es tan valiosa como los recuerdos que captura. Con la tecnología avanzada de restauración de fotos antiguas, puedes revivir tus preciosos recuerdos capturados en momentos especiales. Usa el restaurador de fotos antiguas AI para restaurar foto antigua online y mejorar tu calidad sin necesidad de habilidades. Obtén fotos de alta resolución instantáneamente para más historias familiares.</p>
          <button class="btn" onclick="window.scrollTo({top:0,behavior:'smooth'})">Restaurar foto ahora</button>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      © <span id="year"></span> FotoRestaurador AI · Proyecto demo gratuito. La clave de API se almacena en tu navegador.
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    // ============ Utilidades UI ============ 
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => [...el.querySelectorAll(s)];
    const toast = (msg, ms=3000) => {
      const el = $('#toast'); el.textContent = msg; el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), ms);
    };

    // ============ Tema claro/oscuro ============ 
    const themeBtn = $('#themeBtn');
    const iconSun = $('#iconSun');
    const iconMoon = $('#iconMoon');
    function applyTheme(t){
      if(t==='dark'){ document.body.classList.add('dark'); iconSun.style.display='none'; iconMoon.style.display='block'; }
      else { document.body.classList.remove('dark'); iconSun.style.display='block'; iconMoon.style.display='none'; }
      localStorage.setItem('theme', t);
    }
    const storedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
    applyTheme(storedTheme);
    themeBtn.addEventListener('click',()=>applyTheme(document.body.classList.contains('dark')?'light':'dark'));

    // ============ Año footer ============ 
    $('#year').textContent = new Date().getFullYear();

    // ============ Comparador ============ 
    const range = $('#range');
    const imgAfter = $('#imgAfter');
    const dragLine = $('#dragLine');
    const handle = $('#handle');
    function setCompare(val){
      val = Math.max(0, Math.min(100, Number(val)));
      imgAfter.style.clipPath = `inset(0 ${100-val}% 0 0)`;
      dragLine.style.left = handle.style.left = `${val}%`;
    }
    setCompare(range.value);
    range.addEventListener('input', e=>setCompare(e.target.value));

    // ============ API Key ============ 
    const apiKeyInput = $('#apiKeyInput');
    const saveKeyBtn = $('#saveKeyBtn');
    apiKeyInput.value = localStorage.getItem('GEMINI_API_KEY') || '';
    saveKeyBtn.addEventListener('click', ()=> {
      localStorage.setItem('GEMINI_API_KEY', apiKeyInput.value.trim());
      toast('API Key guardada en este navegador');
    });

    // ============ Uploader y elementos ============ 
    const fileInput = $('#fileInput');
    const drop = $('#drop');
    const dropText = $('#drop-text');
    const chooseBtn = $('#chooseBtn');
    const runBtn = $('#runBtn');
    const removeBtn = $('#removeBtn');
    const statusEl = $('#status');
    const errorMessage = $('#errorMessage');
    const imgBefore = $('#imgBefore');
    const downloadBtn = $('#downloadBtn');
    const imagePreview = $('#imagePreview');
    const progressBar = $('#progressBar');
    const progressFill = $('#progressFill');

    let currentBeforeDataUrl = null;
    let currentBeforeMime = null;

    // ============ Event Listeners ============
    chooseBtn.addEventListener('click', ()=>fileInput.click());
    drop.addEventListener('click', e=> {
      if(e.target.closest('.controls')) return;
      fileInput.click();
    });

    // Función para quitar la imagen
    removeBtn.addEventListener('click', () => {
      imagePreview.style.display = 'none';
      imagePreview.src = '';
      dropText.style.display = 'block';
      chooseBtn.style.display = 'inline-block';
      runBtn.style.display = 'none';
      removeBtn.style.display = 'none';
      downloadBtn.style.display = 'none';
      progressBar.style.display = 'none';
      statusEl.textContent = '';
      errorMessage.style.display = 'none';
      currentBeforeDataUrl = null;
      currentBeforeMime = null;
      setCompare(50);
      toast('Imagen eliminada');
    });

    // Drag & drop
    ['dragenter','dragover'].forEach(evt=>drop.addEventListener(evt, e=>{e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover');}));
    ['dragleave','drop'].forEach(evt=>drop.addEventListener(evt, e=>{e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover');}));
    drop.addEventListener('drop', e=> {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f) handleFile(f);
    });
    
    // Paste
    document.addEventListener('paste', e=> {
      const items = e.clipboardData?.items;
      if(!items) return;
      for(const it of items){
        if(it.type.startsWith('image/')){
          const f = it.getAsFile(); if(f) { handleFile(f); break; }
        }
      }
    });
    
    fileInput.addEventListener('change', e=> {
      const f = e.target.files[0]; if(f) handleFile(f);
    });

    // ============ Manejo de archivos ============
    function handleFile(file){
      if(!file || !file.type.startsWith('image/')){ 
        showError('Selecciona un archivo de imagen válido (JPG, PNG, WEBP)'); 
        return; 
      }
      
      // Validar tamaño (máximo 10MB)
      if(file.size > 10 * 1024 * 1024) {
        showError('La imagen es demasiado grande. Máximo 10MB.');
        return;
      }
      
      hideError();
      const reader = new FileReader();
      reader.onload = e=> {
        currentBeforeDataUrl = e.target.result;
        currentBeforeMime = file.type;
        imgBefore.src = currentBeforeDataUrl;
        
        // Mostrar vista previa
        imagePreview.src = currentBeforeDataUrl;
        imagePreview.style.display = 'block';
        dropText.style.display = 'none';
        
        // Cambiar visibilidad de botones
        chooseBtn.style.display = 'none';
        runBtn.style.display = 'inline-block';
        removeBtn.style.display = 'inline-block';
        
        setCompare(50);
        downloadBtn.style.display = 'none';
        statusEl.textContent = 'Imagen cargada. Haz clic en "Restaurar" para procesar.';
      };
      reader.readAsDataURL(file);
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      toast(message);
    }

    function hideError() {
      errorMessage.style.display = 'none';
    }

    function updateProgress(percent) {
      progressFill.style.width = `${percent}%`;
      if (percent > 0) {
        progressBar.style.display = 'block';
      } else {
        progressBar.style.display = 'none';
      }
    }

    // ========= Función mejorada para llamar a Gemini =========
    async function restoreWithGemini({apiKey, imageDataUrl, mimeType}) {
      // Validar entrada
      if (!apiKey) throw new Error('API Key requerida');
      if (!imageDataUrl) throw new Error('Imagen requerida');
      
      // Convierte DataURL -> base64 puro
      const base64 = imageDataUrl.split(',')[1];
      if (!base64) throw new Error('Formato de imagen inválido');

      // Prompt mejorado para restauración de fotos
      const prompt = `Analyze this old or damaged photograph and restore it by:
1. Enhancing clarity and sharpness
2. Reducing noise and grain
3. Fixing scratches, tears, or damage
4. Improving contrast and brightness
5. Preserving the original composition and style
6. If the photo is black and white, you may add natural colors

Please provide a high-quality restored version of this photograph while maintaining its historical authenticity.`;

      const payload = {
        contents: [
          {
            role: "user",
            parts: [
              { text: prompt },
              { 
                inlineData: { 
                  mimeType: mimeType || "image/jpeg", 
                  data: base64 
                } 
              }
            ]
          }
        ],
        generationConfig: {
          responseModalities: ["IMAGE"],
          maxOutputTokens: 2048,
          temperature: 0.1
        }
      };

      // Usar endpoint no-streaming para mayor compatibilidad
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${encodeURIComponent(apiKey)}`;
      
      const response = await fetch(url, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorText = await response.text();
        let errorMessage = `Error HTTP ${response.status}`;
        
        try {
          const errorJson = JSON.parse(errorText);
          if (errorJson.error?.message) {
            errorMessage = errorJson.error.message;
          }
        } catch (e) {
          // Si no se puede parsear el JSON, usar el texto tal como está
          errorMessage = errorText || errorMessage;
        }
        
        throw new Error(errorMessage);
      }

      const data = await response.json();
      
      // Buscar imagen en la respuesta
      function findImage(obj) {
        if (!obj || typeof obj !== 'object') return null;
        
        if (obj.inlineData?.data && obj.inlineData?.mimeType) {
          return `data:${obj.inlineData.mimeType};base64,${obj.inlineData.data}`;
        }
        
        for (const key in obj) {
          const result = findImage(obj[key]);
          if (result) return result;
        }
        
        return null;
      }

      const restoredImageUrl = findImage(data);
      if (!restoredImageUrl) {
        console.error('Respuesta completa:', JSON.stringify(data, null, 2));
        throw new Error('La API no devolvió ninguna imagen. Verifica tu API key y que el modelo esté disponible.');
      }

      return { dataUrl: restoredImageUrl };
    }

    // ========= Ejecutar restauración =========
    runBtn.addEventListener('click', async ()=> {
      const apiKey = (apiKeyInput.value || localStorage.getItem('GEMINI_API_KEY') || '').trim();
      if(!apiKey){ 
        showError('Introduce tu GEMINI_API_KEY y pulsa Guardar.'); 
        return; 
      }

      if (!currentBeforeDataUrl) {
        showError('Por favor, carga una imagen primero.');
        return;
      }

      try {
        hideError();
        runBtn.disabled = true;
        runBtn.textContent = 'Restaurando...';
        statusEl.textContent = 'Preparando imagen...';
        updateProgress(10);

        // Simular progreso
        setTimeout(() => {
          statusEl.textContent = 'Enviando a Gemini AI...';
          updateProgress(30);
        }, 500);

        setTimeout(() => {
          statusEl.textContent = 'Procesando con IA...';
          updateProgress(60);
        }, 1000);

        const result = await restoreWithGemini({
          apiKey, 
          imageDataUrl: currentBeforeDataUrl, 
          mimeType: currentBeforeMime
        });

        updateProgress(90);
        statusEl.textContent = 'Aplicando resultado...';

        imgAfter.src = result.dataUrl;
        setCompare(50);
        downloadBtn.style.display = 'inline-flex';
        
        updateProgress(100);
        statusEl.textContent = 'Restauración completada. Usa el deslizador para comparar o descarga el resultado.';
        toast('¡Foto restaurada exitosamente! ✅');
        
        // Ocultar barra de progreso después de 2 segundos
        setTimeout(() => updateProgress(0), 2000);

      } catch(err) {
        console.error('Error en restauración:', err);
        updateProgress(0);
        
        let errorMsg = err?.message || 'Error desconocido';
        
        // Mejorar mensajes de error comunes
        if (errorMsg.includes('API_KEY_INVALID')) {
          errorMsg = 'API Key inválida. Verifica que sea correcta.';
        } else if (errorMsg.includes('PERMISSION_DENIED')) {
          errorMsg = 'Permisos denegados. Verifica tu API Key y cuota.';
        } else if (errorMsg.includes('QUOTA_EXCEEDED')) {
          errorMsg = 'Cuota excedida. Espera un momento o verifica tu plan.';
        } else if (errorMsg.includes('MODEL_NOT_FOUND')) {
          errorMsg = 'Modelo no disponible. El servicio puede estar temporalmente inactivo.';
        }
        
        showError(errorMsg);
        statusEl.textContent = '';
        
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = 'Restaurar Foto Ahora';
      }
    });

    // ========= Descargar resultado =========
    downloadBtn.addEventListener('click', async ()=> {
      try {
        const url = imgAfter.src;
        if (!url || url.includes('data:image/svg+xml')) {
          toast('No hay imagen restaurada para descargar');
          return;
        }
        
        // Si es data URL, crear blob para descarga
        if (url.startsWith('data:')) {
          const response = await fetch(url);
          const blob = await response.blob();
          const objectUrl = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = objectUrl;
          a.download = `foto-restaurada-${Date.now()}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          
          // Liberar memoria
          setTimeout(() => URL.revokeObjectURL(objectUrl), 100);
        } else {
          // Para URLs normales
          const a = document.createElement('a');
          a.href = url;
          a.download = `foto-restaurada-${Date.now()}.png`;
          a.target = '_blank';
          document.body.appendChild(a);
          a.click();
          a.remove();
        }
        
        toast('Descarga iniciada ⬇️');
        
      } catch (err) {
        console.error('Error al descargar:', err);
        toast('Error al descargar la imagen');
      }
    });
  </script>
</body>
</html>